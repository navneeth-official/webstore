image: node:20-bullseye

stages:
  - install
  - build

# Cache node modules between pipeline runs to speed up installs
cache:
  key: "${CI_PROJECT_ID}-${CI_COMMIT_REF_SLUG}"
  paths:
    - node_modules/
    - .npm

variables:
  NPM_CONFIG_LOGLEVEL: warn

install_dependencies:
  stage: install
  script:
    - npm ci --prefer-offline --no-audit --progress=false
  artifacts:
    # Preserve node_modules for downstream jobs on GitLab runners that support artifacts
    paths:
      - node_modules/
    expire_in: 1h

# Build the Angular app and publish `dist/` as job artifacts
build:
  stage: build
  needs:
    - job: install_dependencies
      artifacts: true
  script:
    # Use the project's build script. Adjust `--configuration` if you use a different config.
    - npm run build -- --configuration production
  artifacts:
    paths:
      - dist/
    expire_in: 1 week
  only:
    - branches
    - tags

# Optional manual test job: Angular unit tests typically need a headless browser available in CI
# and can fail on runners without browsers installed. Keep this manual so the pipeline runs clean
# by default. Uncomment or adapt this job if you have an image with Chrome/Chromium or you
# install it in the job before running `npm test`.
test_manual:
  stage: build
  when: manual
  script:
    - echo "Tests are manual in this CI by default. Configure this job to install Chromium or use a node image with browsers and then run 'npm test'."
  allow_failure: true
